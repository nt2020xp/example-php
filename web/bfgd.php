<?php
/*
CCTV1高清
http://IP/bfgd.php?id=201
CCTV1高清
http://IP/bfgd.php?id=484
CCTV1高清
http://IP/bfgd.php?id=488
CCTV1高清
http://IP/bfgd.php?id=489
CCTV2高清
http://IP/bfgd.php?id=061
CCTV3高清
http://IP/bfgd.php?id=062
CCTV4高清
http://IP/bfgd.php?id=063
CCTV5高清
http://IP/bfgd.php?id=064
CCTV5+高清
http://IP/bfgd.php?id=246
CCTV6高清
http://IP/bfgd.php?id=065
CCTV7高清
http://IP/bfgd.php?id=127
CCTV8高清
http://IP/bfgd.php?id=066
CCTV9高清
http://IP/bfgd.php?id=128
CCTV10高清
http://IP/bfgd.php?id=129
CCTV11高清
http://IP/bfgd.php?id=130
CCTV12高清
http://IP/bfgd.php?id=131
CCTV13高清
http://IP/bfgd.php?id=067
CCTV14高清
http://IP/bfgd.php?id=132
CCTV15高清
http://IP/bfgd.php?id=133
CCTV17高清
http://IP/bfgd.php?id=204
CETV1高清
http://IP/bfgd.php?id=135
CETV2
http://IP/bfgd.php?id=492
CGTN
http://IP/bfgd.php?id=134
CGTN西班牙语
http://IP/bfgd.php?id=306
CGTN阿拉伯语
http://IP/bfgd.php?id=308
CGTN法语
http://IP/bfgd.php?id=307
CGTN
http://IP/bfgd.php?id=305
CGTN俄语
http://IP/bfgd.php?id=309
求索动物
http://IP/bfgd.php?id=287
求索生活
http://IP/bfgd.php?id=288
求索地理
http://IP/bfgd.php?id=286
国学频道
http://IP/bfgd.php?id=169
发现之旅
http://IP/bfgd.php?id=151
老故事
http://IP/bfgd.php?id=166
女性时尚
http://IP/bfgd.php?id=176
世界地理
http://IP/bfgd.php?id=177
江苏卫视高清
http://IP/bfgd.php?id=085
天津卫视高清
http://IP/bfgd.php?id=084
湖南卫视高清
http://IP/bfgd.php?id=086
北京卫视高清
http://IP/bfgd.php?id=083
黑龙江卫视高清
http://IP/bfgd.php?id=095
广东卫视高清
http://IP/bfgd.php?id=092
东方卫视高清
http://IP/bfgd.php?id=093
浙江卫视高清
http://IP/bfgd.php?id=094
吉林卫视高清
http://IP/bfgd.php?id=097
安徽卫视高清
http://IP/bfgd.php?id=096
江西卫视高清
http://IP/bfgd.php?id=098
山东卫视高清
http://IP/bfgd.php?id=099
贵州卫视高清
http://IP/bfgd.php?id=101
深圳卫视高清
http://IP/bfgd.php?id=100
湖北卫视高清
http://IP/bfgd.php?id=102
四川卫视高清
http://IP/bfgd.php?id=103
陕西卫视高清
http://IP/bfgd.php?id=512
河南卫视高清
http://IP/bfgd.php?id=339
海南卫视高清
http://IP/bfgd.php?id=473
云南卫视高清
http://IP/bfgd.php?id=482
东南卫视高清
http://IP/bfgd.php?id=483
重温经典
http://IP/bfgd.php?id=636
金鹰卡通
http://IP/bfgd.php?id=105
河南卫视
http://IP/bfgd.php?id=104
北京卡酷少儿
http://IP/bfgd.php?id=106
重庆卫视高清
http://IP/bfgd.php?id=107
山西卫视
http://IP/bfgd.php?id=109
河北卫视高清
http://IP/bfgd.php?id=108
青海卫视
http://IP/bfgd.php?id=111
内蒙古卫视
http://IP/bfgd.php?id=110
山东教育卫视
http://IP/bfgd.php?id=112
北京纪实科教高清
http://IP/bfgd.php?id=113
广西卫视高清
http://IP/bfgd.php?id=116
云南卫视
http://IP/bfgd.php?id=115
宁夏卫视
http://IP/bfgd.php?id=118
陕西卫视
http://IP/bfgd.php?id=114
延边卫视
http://IP/bfgd.php?id=117
甘肃卫视
http://IP/bfgd.php?id=119
西藏卫视
http://IP/bfgd.php?id=121
农林卫视
http://IP/bfgd.php?id=122
兵团卫视
http://IP/bfgd.php?id=124
家庭影院
http://IP/bfgd.php?id=289
家庭剧场
http://IP/bfgd.php?id=290
外国影院
http://IP/bfgd.php?id=291
综艺
http://IP/bfgd.php?id=292
午夜影院
http://IP/bfgd.php?id=294
纪录片
http://IP/bfgd.php?id=295
游戏竞技
http://IP/bfgd.php?id=296
儿童动漫
http://IP/bfgd.php?id=293
3D影院
http://IP/bfgd.php?id=298
绘画
http://IP/bfgd.php?id=297
家庭理财
http://IP/bfgd.php?id=139
网络棋牌
http://IP/bfgd.php?id=141
游戏竞技
http://IP/bfgd.php?id=142
天元围棋
http://IP/bfgd.php?id=144
电子体育
http://IP/bfgd.php?id=143
环球旅游
http://IP/bfgd.php?id=147
车迷频道
http://IP/bfgd.php?id=146
生态环境
http://IP/bfgd.php?id=149
优优宝贝
http://IP/bfgd.php?id=153
新疆卫视
http://IP/bfgd.php?id=150
收藏天下
http://IP/bfgd.php?id=155
中华特产
http://IP/bfgd.php?id=158
中国天气
http://IP/bfgd.php?id=160
法治天地
http://IP/bfgd.php?id=162
电视指南
http://IP/bfgd.php?id=164
家政
http://IP/bfgd.php?id=167
重庆汽摩
http://IP/bfgd.php?id=168
茶频道
http://IP/bfgd.php?id=181
书画
http://IP/bfgd.php?id=180
百姓健康
http://IP/bfgd.php?id=219
摄影频道
http://IP/bfgd.php?id=222
财富天下
http://IP/bfgd.php?id=231
四海钓鱼
http://IP/bfgd.php?id=229
先锋乒羽
http://IP/bfgd.php?id=349
证券服务
http://IP/bfgd.php?id=610
天元围棋
http://IP/bfgd.php?id=633
辽宁卫视高清
http://IP/bfgd.php?id=058
辽宁都市高清
http://IP/bfgd.php?id=610
辽宁北方高清
http://IP/bfgd.php?id=071
辽宁生活高清
http://IP/bfgd.php?id=073
辽宁体育高清
http://IP/bfgd.php?id=611
辽宁影视剧高清
http://IP/bfgd.php?id=070
辽宁教育青少高清
http://IP/bfgd.php?id=075
辽宁经济高清
http://IP/bfgd.php?id=076
辽宁公共高清
http://IP/bfgd.php?id=077
辽宁公共高清
http://IP/bfgd.php?id=481
辽宁经济高清
http://IP/bfgd.php?id=480
北方导视高清
http://IP/bfgd.php?id=187
辽宁新动漫
http://IP/bfgd.php?id=140
社区老年教育课堂
http://IP/bfgd.php?id=615
沈阳新闻综合高清
http://IP/bfgd.php?id=059
抚顺综合
http://IP/bfgd.php?id=275
鞍山新闻综合
http://IP/bfgd.php?id=274
大连新闻综合
http://IP/bfgd.php?id=273
丹东新闻综合
http://IP/bfgd.php?id=276
锦州新闻综合
http://IP/bfgd.php?id=277
阜新综合
http://IP/bfgd.php?id=279
辽阳新闻综合
http://IP/bfgd.php?id=280
营口新闻综合
http://IP/bfgd.php?id=278
盘锦新闻综合
http://IP/bfgd.php?id=283
铁岭新闻综合
http://IP/bfgd.php?id=281
朝阳新闻综合
http://IP/bfgd.php?id=282
本溪综合
http://IP/bfgd.php?id=312
连山区综合
http://IP/bfgd.php?id=491
龙港区综合
http://IP/bfgd.php?id=490
葫芦岛新闻综合
http://IP/bfgd.php?id=284
*/
$head_httplive = 'http://httplive.slave.bfgd.com.cn:14311';
$head_httpstream = 'http://httpstream.slave.bfgd.com.cn:14312';

function getcurl($url) {
    $user_agent = "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)";
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url); // 设置要访问的URL
    curl_setopt($ch, CURLOPT_USERAGENT, $user_agent); // 模拟用户使用的浏览器
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); // 使用自动跳转
    curl_setopt($ch, CURLOPT_TIMEOUT, 60); // 设置超时时间
    curl_setopt($ch, CURLOPT_AUTOREFERER, 1); // 自动设置Referer
    curl_setopt($ch, CURLOPT_HEADER, 0); // 不显示返回的HEAD区域的内容
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); // 返回结果而不是输出
    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        echo 'Error:' . curl_error($ch); // 处理cURL错误
    }
    curl_close($ch);
    return $result;
}

function getinfo_json($chnlid, $token) {
    $i_url = 'http://slave.bfgd.com.cn/media/channel/get_info?chnlid=4200000' . $chnlid . '&accesstoken=' . $token;
    $i_result = file_get_contents($i_url);
    return json_decode($i_result);
}

$accesstoken = 'R5F2408FEU3198804BK78052214IE73560DFP2BF4M340CE68V0Z339CBW1626D4D261E46FEA';

$id = isset($_GET['id']) ? $_GET['id'] : '610';
$type = isset($_GET['type']) ? $_GET['type'] : 'live';

if ($type == 'live') {
    // 直播
    header("ACCESS-CONTROL-ALLOW-ORIGIN:*");
    $json = getinfo_json($id, $accesstoken);
    $playtoken = isset($json->play_token) ? $json->play_token : 'ABCDEFGH';
    $playurl = $head_httplive . '/playurl?playtype=live&protocol=hls&accesstoken=' . $accesstoken . '&programid=4200000' . $id . '&playtoken=' . $playtoken;
    $m3u8 = getcurl($playurl);
    echo preg_replace('/(http):\/\/([^\/]+)/i', $head_httplive, $m3u8);
} elseif ($type == 'list') {
    // 节目单
    $date = isset($_GET['date']) ? $_GET['date'] : date('Y-m-d');
    $time = time();
    $json = getinfo_json($id, $accesstoken);
    echo $json->chnl_name . " " . $date . " 节目单<br/>";
    $list_url = 'http://slave.bfgd.com.cn/media/event/get_list?chnlid=4200000' . $id . '&pageidx=1&vcontrol=0&attachdesc=1&repeat=1&accesstoken=' . $accesstoken . '&starttime=' . strtotime($date) . '&endtime=' . strtotime('+1 day', strtotime($date)) . '&pagenum=100&flagposter=0';
    $list_result = file_get_contents($list_url);
    $list_json = json_decode($list_result);
    $event_list = $list_json->event_list;
    for ($x = 0; $x < count($event_list); $x++) {
        $url = 'bfgd.php?type=back&start=' . date('YmdHis', $event_list[$x]->start_time) . '&end=' . date('YmdHis', $event_list[$x]->end_time) . '&event_id=' . $event_list[$x]->event_id;
        $n = date('H:i', $event_list[$x]->start_time) . ' ' . $event_list[$x]->event_name;
        if ($time > $event_list[$x]->end_time) {
            echo "<a href='{$url}' title=''>$n</a><br/>";
        } else {
            echo $n . "<br/>";
        }
    }
} elseif ($type == 'back') {
    // 回看
    header("ACCESS-CONTROL-ALLOW-ORIGIN:*");
    $start = $_GET['start'];
    $end = $_GET['end'];
    $eventid = $_GET['event_id'];
    $url = 'http://slave.bfgd.com.cn/media/event/get_info?accesstoken=' . $accesstoken . '&eventid=' . $eventid;
    $result = file_get_contents($url);
    $json = json_decode($result);
    $_playtoken = $json->play_token;
    $playurl = $head_httpstream . '/playurl?playtype=lookback&protocol=hls&starttime=' . $start . '&endtime=' . $end . '&accesstoken=' . $accesstoken . '&programid=' . $eventid . '&playtoken=' . $_playtoken;
    $m3u8 = getcurl($playurl);
    echo preg_replace('/(http):\/\/([^\/]+)/i', $head_httpstream, $m3u8);
}
?>
