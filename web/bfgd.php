<?php
/*
 * 電視直播系統 (簡化版)
 * 版本：2023-12-20
 * 功能：僅保留直播功能，包含完整頻道列表
 */

// 設定時區
date_default_timezone_set('Asia/Shanghai');

// 常數定義
define('LIVE_SERVER', 'http://httplive.slave.bfgd.com.cn:14311');
define('ACCESS_TOKEN', 'R5F2408FEU3198804BK78052214IE73560DFP2BF4M340CE68V0Z339CBW1626D4D261E46FEA');
define('CHANNEL_PREFIX', '4200000');

// 完整頻道ID映射
$channelMap = [
    '201' => 'CCTV1高清',
    '484' => 'CCTV1高清',
    '488' => 'CCTV1高清',
    '489' => 'CCTV1高清',
    '061' => 'CCTV2高清',
    '062' => 'CCTV3高清',
    '063' => 'CCTV4高清',
    '064' => 'CCTV5高清',
    '246' => 'CCTV5+高清',
    '065' => 'CCTV6高清',
    '127' => 'CCTV7高清',
    '066' => 'CCTV8高清',
    '128' => 'CCTV9高清',
    '129' => 'CCTV10高清',
    '130' => 'CCTV11高清',
    '131' => 'CCTV12高清',
    '067' => 'CCTV13高清',
    '132' => 'CCTV14高清',
    '133' => 'CCTV15高清',
    '204' => 'CCTV17高清',
    '135' => 'CETV1高清',
    '492' => 'CETV2',
    '134' => 'CGTN',
    '306' => 'CGTN西班牙語',
    '308' => 'CGTN阿拉伯語',
    '307' => 'CGTN法語',
    '305' => 'CGTN',
    '309' => 'CGTN俄語',
    '287' => '求索動物',
    '288' => '求索生活',
    '286' => '求索地理',
    '169' => '國學頻道',
    '151' => '發現之旅',
    '166' => '老故事',
    '176' => '女性時尚',
    '177' => '世界地理',
    '085' => '江蘇衛視高清',
    '084' => '天津衛視高清',
    '086' => '湖南衛視高清',
    '083' => '北京衛視高清',
    '095' => '黑龍江衛視高清',
    '092' => '廣東衛視高清',
    '093' => '東方衛視高清',
    '094' => '浙江衛視高清',
    '097' => '吉林衛視高清',
    '096' => '安徽衛視高清',
    '098' => '江西衛視高清',
    '099' => '山東衛視高清',
    '101' => '貴州衛視高清',
    '100' => '深圳衛視高清',
    '102' => '湖北衛視高清',
    '103' => '四川衛視高清',
    '512' => '陝西衛視高清',
    '339' => '河南衛視高清',
    '473' => '海南衛視高清',
    '482' => '雲南衛視高清',
    '483' => '東南衛視高清',
    '636' => '重溫經典',
    '105' => '金鷹卡通',
    '104' => '河南衛視',
    '106' => '北京卡酷少兒',
    '107' => '重慶衛視高清',
    '109' => '山西衛視',
    '108' => '河北衛視高清',
    '111' => '青海衛視',
    '110' => '內蒙古衛視',
    '112' => '山東教育衛視',
    '113' => '北京紀實科教高清',
    '116' => '廣西衛視高清',
    '115' => '雲南衛視',
    '118' => '寧夏衛視',
    '114' => '陝西衛視',
    '117' => '延邊衛視',
    '119' => '甘肅衛視',
    '121' => '西藏衛視',
    '122' => '農林衛視',
    '124' => '兵團衛視',
    '289' => '家庭影院',
    '290' => '家庭劇場',
    '291' => '外國影院',
    '292' => '綜藝',
    '294' => '午夜影院',
    '295' => '紀錄片',
    '296' => '遊戲競技',
    '293' => '兒童動漫',
    '298' => '3D影院',
    '297' => '繪畫',
    '139' => '家庭理財',
    '141' => '網絡棋牌',
    '142' => '遊戲競技',
    '144' => '天元圍棋',
    '143' => '電子體育',
    '147' => '環球旅遊',
    '146' => '車迷頻道',
    '149' => '生態環境',
    '153' => '優優寶貝',
    '150' => '新疆衛視',
    '155' => '收藏天下',
    '158' => '中華特產',
    '160' => '中國天氣',
    '162' => '法治天地',
    '164' => '電視指南',
    '167' => '家政',
    '168' => '重慶汽摩',
    '181' => '茶頻道',
    '180' => '書畫',
    '219' => '百姓健康',
    '222' => '攝影頻道',
    '231' => '財富天下',
    '229' => '四海釣魚',
    '349' => '先鋒乒羽',
    '610' => '證券服務',
    '633' => '天元圍棋',
    '058' => '遼寧衛視高清',
    '610' => '遼寧都市高清',
    '071' => '遼寧北方高清',
    '073' => '遼寧生活高清',
    '611' => '遼寧體育高清',
    '070' => '遼寧影視劇高清',
    '075' => '遼寧教育青少高清',
    '076' => '遼寧經濟高清',
    '077' => '遼寧公共高清',
    '481' => '遼寧公共高清',
    '480' => '遼寧經濟高清',
    '187' => '北方導視高清',
    '140' => '遼寧新動漫',
    '615' => '社區老年教育課堂',
    '059' => '瀋陽新聞綜合高清',
    '275' => '撫順綜合',
    '274' => '鞍山新聞綜合',
    '273' => '大連新聞綜合',
    '276' => '丹東新聞綜合',
    '277' => '錦州新聞綜合',
    '279' => '阜新綜合',
    '280' => '遼陽新聞綜合',
    '278' => '營口新聞綜合',
    '283' => '盤錦新聞綜合',
    '281' => '鐵嶺新聞綜合',
    '282' => '朝陽新聞綜合',
    '312' => '本溪綜合',
    '491' => '連山區綜合',
    '490' => '龍港區綜合',
    '284' => '葫蘆島新聞綜合'
];

// 獲取頻道信息
function getChannelInfo($channelId) {
    $apiUrl = 'http://slave.bfgd.com.cn/media/channel/get_info?' . http_build_query([
        'chnlid' => CHANNEL_PREFIX . $channelId,
        'accesstoken' => ACCESS_TOKEN
    ]);
    
    $response = @file_get_contents($apiUrl);
    if ($response === false) {
        return null;
    }
    
    return json_decode($response);
}

// 獲取播放URL
function getPlayUrl($channelId, $playToken) {
    return LIVE_SERVER . '/playurl?' . http_build_query([
        'playtype' => 'live',
        'protocol' => 'hls',
        'accesstoken' => ACCESS_TOKEN,
        'programid' => CHANNEL_PREFIX . $channelId,
        'playtoken' => $playToken
    ]);
}

// 主處理流程
$id = isset($_GET['id']) ? preg_replace('/[^0-9]/', '', $_GET['id']) : '610';

if (!array_key_exists($id, $channelMap)) {
    http_response_code(404);
    header('Content-Type: text/plain; charset=utf-8');
    exit('頻道不存在');
}

$channelInfo = getChannelInfo($id);
if (!$channelInfo) {
    http_response_code(503);
    header('Content-Type: text/plain; charset=utf-8');
    exit('無法獲取頻道信息');
}

$playToken = $channelInfo->play_token ?? 'DEFAULT_TOKEN';
$playUrl = getPlayUrl($id, $playToken);

header("Access-Control-Allow-Origin: *");
header('Content-Type: application/vnd.apple.mpegurl');
readfile($playUrl);
